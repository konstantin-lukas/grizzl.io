name: Update Playwright Screenshots

on:
    workflow_dispatch:

jobs:
    install-deps:
        runs-on: ubuntu-24.04
        outputs:
            cache-hit: ${{ steps.npm-cache.outputs.cache-hit }}
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "24"

            - name: Cache node_modules
              id: npm-cache
              uses: actions/cache@v4
              with:
                  path: |
                      **/node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

            - name: Install dependencies
              run: npm ci

    update-snapshots:
        needs: install-deps
        runs-on: ubuntu-latest

        permissions:
            contents: write

        steps:
            - name: Ensure workflow is running on a branch
              run: |
                  if [ "${{ github.ref_type }}" != "branch" ]; then
                    echo "This workflow must be run on a branch."
                    exit 1
                  fi

            - name: Checkout selected branch
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.ref_name }}
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"

            - name: Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: |
                      **/node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

            - name: Start Isolated Container Stack
              run: |
                  export DOCKER_USER_ID="$(id -u)"
                  export DOCKER_GROUP_ID="$(id -g)"
                  docker compose -f compose.test.yml up -d

            - name: Run Playwright Tests
              run: |
                  export DOCKER_USER_ID="$(id -u)"
                  export DOCKER_GROUP_ID="$(id -g)"
                  docker compose run --rm -e CI=true playwright npx playwright test --update-snapshots

            - name: Configure git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Add changed PNG snapshots
              run: |
                  git add tests/e2e/snapshots/**/*.png

            - name: Commit and push snapshots if there are changes
              run: |
                  if git diff --cached --quiet; then
                    echo "No snapshot changes to commit."
                  else
                    git commit -m "chore(e2e): update screenshots"
                    git push origin "${{ github.ref_name }}"
                  fi
